name: DevSecOps CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write # Wymagane, aby wrzucić raporty bezpieczeństwa do zakładki Security w GitHub

jobs:
  # ---------------------------------------------------
  # JOB 1: QUALTY & TESTS (Jakość kodu i testy funkcjonalne)
  # ---------------------------------------------------
  build-and-test:
    name: Build, Lint & Unit Tests
    runs-on: ubuntu-latest
    
    env:
      SECRET_KEY: ${{ secrets.DJANGO_CI_KEY }}
      DEBUG: 'False'
      DB_NAME: 'db.sqlite3' # Dla testów CI wystarczy SQLite

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # LINTING (Czystość kodu)
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # SYSTEM CHECK (Czy Django w ogóle działa)
      - name: Django System Check
        run: python manage.py check

      # UNIT & INTEGRATION TESTS (to dopiero trzeba bedzie zrobic albo i nie...)

  # ---------------------------------------------------
  # JOB 2: SECURITY SAST & SCA (Bezpieczeństwo statyczne)
  # ---------------------------------------------------
  security-scans:
    name: Security Checks (SAST, SCA, Secrets)
    runs-on: ubuntu-latest
    needs: build-and-test # Uruchom tylko, jeśli build przeszedł
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      # 1. SAST: Bandit (uruchamiany bezpośrednio)
      - name: Install and Run Bandit (SAST)
        run: |
          pip install bandit 
          bandit -r . -ll || true
# -------------------------------------------------------
      # 2. TRIVY (SCA & Secrets) - Oficjalna Akcja
      # Konfiguracja: scan-type: 'fs' (FileSystem)
      # -------------------------------------------------------
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'        # KLUCZOWE: Skanuj pliki, nie obrazy Dockera
          scan-ref: '.'          # Skanuj obecny katalog
          hide-progress: false
          format: 'table'
          exit-code: '0'         # 0 = nie blokuj pipeline (dla nauki), 1 = blokuj
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret,config' # Skanuj podatności, sekrety i config

  # ---------------------------------------------------
  # JOB 3: DAST (Dynamiczne skanowanie - Opcjonalne)
  # ---------------------------------------------------
  dast-scan:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # Aby zrobić DAST, aplikacja musi działać.
      # Uruchamiamy ją w tle w kontenerze/procesie, a potem skanujemy.
      - name: Set up Python & Run App
        run: |
          pip install -r requirements.txt
          python manage.py migrate
          # Uruchomienie serwera w tle (&)
          python manage.py runserver 0.0.0.0:8000 &
          sleep 10 
        # Czekamy aż wstanie

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'http://localhost:8000'
          # Failuj tylko na bardzo poważnych błędach, bo ZAP często zgłasza "false positives"
          fail_action: false 
          cmd_options: '-a'
